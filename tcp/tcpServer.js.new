const net = require("net");
require("dotenv").config();
const { CabsDetails } = require("../models");
const { getBroadcastGPS } = require("../websocket");

const TCP_PORT = parseInt(process.env.GPS_TCP_PORT || "4000", 10);
const TCP_HOST = process.env.GPS_TCP_HOST || "0.0.0.0";

const verifiedIMEIs = new Set();

console.log("🚦 Starting TCP Server...");

// Helper functions
function decodeIMEI(imeiHex) {
  return imeiHex.replace(/^0+/, "");
}

function calculateCRC(data) {
  let crc = 0xFFFF;
  for (let i = 0; i < data.length; i++) {
    crc ^= data[i] << 8;
    for (let j = 0; j < 8; j++) {
      if (crc & 0x8000) crc = (crc << 1) ^ 0x1021;
      else crc <<= 1;
      crc &= 0xFFFF;
    }
  }
  return crc;
}

function createACK(protocol, serialNumber) {
  const startBit = "7878";
  const contentLength = "05";
  const dataHex = contentLength + protocol + serialNumber;
  const dataBuffer = Buffer.from(dataHex, "hex");
  const crc = calculateCRC(dataBuffer);
  const crcHex = crc.toString(16).padStart(4, "0").toUpperCase();
  const endBit = "0D0A";
  const ackPacket = startBit + contentLength + protocol + serialNumber + crcHex + endBit;
  console.log(`📦 Calculated ACK: ${ackPacket}`);
  return ackPacket;
}

function sendConfigCommand(socket, command, description) {
  console.log(`📤 Sending ${description}:`, command);
  socket.write(Buffer.from(command, 'hex'));
}

function configureGPSDevice(socket) {
  console.log("🔧 Configuring GPS device for 10-second intervals...");
  setTimeout(() => {
    const intervalCommand = "787810800C0000000A000000000000004E200D0A"; 
    sendConfigCommand(socket, intervalCommand, "10-second interval configuration");
  }, 1000);
  
  setTimeout(() => {
    const enableCommand = "787808800100010001D9DC0D0A";
    sendConfigCommand(socket, enableCommand, "continuous GPS reporting");
  }, 2000);
}

// Create TCP Server
const tcpServer = net.createServer((socket) => {
  console.log("📡 New GPS device connected");
  let deviceIMEI = null;

  socket.on("data", async (data) => {
    try {
      const hex = data.toString("hex").toUpperCase();
      const raw = data.toString().trim();

      // Allow manual JSON testing
      if (raw.startsWith("{") && raw.endsWith("}")) {
        const parsed = JSON.parse(raw);
        if (parsed.imei && parsed.lat && parsed.lng) {
          getBroadcastGPS()(
            parsed.imei,
            parsed.lat,
            parsed.lng,
            parsed.ignition || false,
            parsed.speed || 0
          );
          console.log(`✅ Broadcasted manual GPS: ${parsed.imei}`);
        }
        socket.write("ACK: JSON received\n");
        return;
      }

      if (!hex.startsWith("7878")) return;
      const protocol = hex.substr(6, 2);

      // Login Packet
      if (protocol === "01") {
        const imeiHex = hex.substring(8, 24);
        const imei = decodeIMEI(imeiHex);
        deviceIMEI = imei;
        console.log(`🔑 Login IMEI: ${imei}`);
        const cab = await CabsDetails.findOne({ where: { imei } });
        if (cab) verifiedIMEIs.add(imei);
        const serialNumber = hex.substring(24, 28);
        const ack = createACK("01", serialNumber);
        socket.write(Buffer.from(ack, "hex"));
      }

      // Heartbeat
      else if (protocol === "13") {
        const serialNumber = hex.substring(hex.length - 8, hex.length - 4);
        socket.write(Buffer.from(createACK("13", serialNumber), "hex"));
      }

      // GPS Data
      else if (protocol === "22") {
        const latitudeHex = hex.substr(22, 8);
        const longitudeHex = hex.substr(30, 8);
        const speedHex = hex.substr(38, 2);
        const statusHex = hex.substr(44, 2);
        const serialNumber = hex.substring(hex.length - 8, hex.length - 4);

        const lat = parseInt(latitudeHex, 16) / 1800000;
        const lon = parseInt(longitudeHex, 16) / 1800000;
        const speed = parseInt(speedHex, 16);
        const ignition = (parseInt(statusHex, 16) & 0x08) !== 0 || speed > 2;

        console.log(`📍 GPS ${deviceIMEI}: ${lat}, ${lon}, Speed: ${speed}`);

        getBroadcastGPS()(deviceIMEI, lat, lon, ignition, speed);

        socket.write(Buffer.from(createACK("22", serialNumber), "hex"));
      }
    } catch (err) {
      console.error("❌ Error parsing TCP:", err.message);
    }
  });

  socket.on("close", () => console.log("🔌 GPS device disconnected"));
  socket.on("error", (err) => console.error("⚠️ TCP socket error:", err.message));
});

// Start the server
tcpServer.listen(TCP_PORT, TCP_HOST, () => {
  console.log(`🚀 TCP Server listening on ${TCP_HOST}:${TCP_PORT}`);
});
